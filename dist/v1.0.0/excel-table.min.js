/**
 * Created by irelance on 2017/2/9.
 */
getDefaultStyle=function(elem,attribute){return elem.currentStyle?elem.currentStyle[attribute]:document.defaultView.getComputedStyle(elem,false)[attribute]};elementAbsoluteStation=function(elem,station){if(!station){station={left:0,top:0}}if(elem.offsetParent!=null&&getDefaultStyle(elem.offsetParent,'position')!='relative'){station=elementAbsoluteStation(elem.offsetParent,station)}station.left+=elem.offsetLeft;station.top+=elem.offsetTop;return station};downloadURI=function(uri,name){var aLink=document.createElement('a');aLink.download=name;aLink.href=uri;document.body.appendChild(aLink);aLink.click();document.body.removeChild(aLink)};Rectangle=function(){this.type='rectangle';this.sRow=0;this.sCol=0;this.eRow=0;this.eCol=0;this.rows=1;this.columns=1;this.isContains=function(rectangle){return rectangle.sRow>=this.sRow&&rectangle.eRow<=this.eRow&&rectangle.sCol>=this.sCol&&rectangle.eCol<=this.eCol};this.setRange=function(sRow,sCol,eRow,eCol){this.sRow=sRow?sRow:0;this.sCol=sCol?sCol:0;this.eRow=eRow?eRow:sRow?sRow:0;this.eCol=eCol?eCol:sCol?sCol:0;this.rows=this.eRow-this.sRow+1;this.columns=this.eCol-this.sCol+1;return this};this.setRangeByDiagonal=function(point1,point2){if(point1[0]>point2[0]){[point1[0],point2[0]]=[point2[0],point1[0]]}if(point1[1]>point2[1]){[point1[1],point2[1]]=[point2[1],point1[1]]}this.setRange(point1[0],point1[1],point2[0],point2[1]);return this};this.setRangeByDistance=function(point,columns,rows){this.setRangeByDiagonal(point,[point[0]+rows-1,point[1]+columns-1]);return this};this.setRangeByRange=function(rowRange,columnRange){this.setRangeByDiagonal([rowRange[0],columnRange[0]],[rowRange[1],columnRange[1]]);return this}};ExcelTable={Unit:function(row,column){this.id=undefined;this.row=row;this.column=column;this.value='';this.result=NaN;this.type='string'},unit:{setValue:function(unit,value){if(typeof value=='number'||(value.match&&value.match(/^(-?\d+)(\.\d+)?$/))){value=parseFloat(value);unit.type='number'}else if(value[0]=='='&&value.length>1){unit.type='function'}else{unit.type='string'}unit.value=value},convert26BSToDS:function(code){var num=-1;var reg=/^[A-Z]+$/g;if(!reg.test(code)){return num}for(var i=code.length-1,j=1;i>=0;i--,j*=26){num+=(code[i].charCodeAt()-64)*j}return num},convertDSTo26BS:function(num){var code='',m;var reg=/^[0-9]+$/g;if(!reg.test(num)){return code}num++;while(num>0){m=num%26;if(m==0){m=26}code=String.fromCharCode(64+parseInt(m))+code;num=(num-m)/26}return code},rulers:[{name:'replace range',sort:1,global:/[A-Z]*[0-9]*:[A-Z]*[0-9]*/g,row:/([0-9]+):([0-9]+)/,col:/([A-Z]+):([A-Z]+)/,range:/([A-Z]+)([0-9]+):([A-Z]+)([0-9]+)/,handle:function(exp,v,i){var matches;if(matches=v.match(this.row)){exp[i]='$row('+matches[1]+','+matches[2]+')'}else if(matches=v.match(this.col)){exp[i]='$col('+ExcelTable.unit.convert26BSToDS(matches[1])+','+ExcelTable.unit.convert26BSToDS(matches[2])+')'}else if(matches=v.match(this.range)){exp[i]='$range(['+matches[2]+','+matches[4]+'],['+ExcelTable.unit.convert26BSToDS(matches[1])+','+ExcelTable.unit.convert26BSToDS(matches[3])+'])'}},render:function(words,v,i){words[i-1]=words[i-1].trim();words[i+1]=words[i+1].trim();if(words[i-1].lastIndexOf('(')==words[i-1].length-1){words[i-1]+='['}if(words[i+1].indexOf(')')==0){words[i+1]=']'+words[i+1]}}},{name:'replace one unit',sort:2,global:/[A-Z]+[0-9]+/g,unit:/([A-Z]+)([0-9]+)/,handle:function(exp,v,i){var matches;if(matches=v.match(this.unit)){exp[i]='$one('+matches[2]+','+ExcelTable.unit.convert26BSToDS(matches[1])+')'}},render:function(words,v,i){}}],parser:function(txt,ruler){var placeholder='<flag/>',breaker='<break/>';var words=txt.replace(ruler.global,breaker+placeholder+breaker).split(breaker);var exp=txt.match(ruler.global);if(exp){exp.forEach(function(v,i){ruler.handle(exp,v,i)});words.forEach(function(v,i){if(v==placeholder){ruler.render(words,v,i);words[i]=exp.shift()}})}txt=words.join('');return txt},parsing:function(txt){this.rulers.sort(function(a,b){return a.sort==b.sort?0:a.sort>b.sort?1:-1});this.rulers.forEach(function(ruler){txt=this.parser(txt,ruler)}.bind(this));return txt}},Table:function(){this.target=undefined;this.table=undefined;this.search=undefined;this.toolbar=undefined;this.selectLines=new ExcelTable.table.SelectLines(this);this.changeLines=new ExcelTable.table.ChangeLines(this);this.range=new Rectangle();this.units=[];this.result=[];this.dimOne2Two=function(){this.result=[];this.units.forEach(function(v){if(!this.result[v.row]){this.result[v.row]=[]}this.result[v.row][v.column]=v}.bind(this))};this.dimTwo2One=function(){this.units=[];this.result.forEach(function(rows){rows.forEach(function(unit){this.units.push(unit)}.bind(this))}.bind(this))};this.createUnit=function(row,column){var unit=new ExcelTable.Unit(row,column);unit.id=this.units.length;this.units.push(unit)};this.render=function(){this.dimOne2Two();var result='<tbody>';this.result.forEach(function(row,i){result+='<tr><th class="excel-table-row" data-row="'+i+'">'+i+'</th>';row.forEach(function(unit,j){this.times=0;try{unit.result=this.calculate(unit)}catch(error){console.log(error);unit.result=NaN}result+=ExcelTable.template.unit(unit)}.bind(this));result+='</tr>'}.bind(this));result+='</tbody>';var header='<thead><tr><th class="excel-table-dig"></th>';for(var i=0;i<this.range.columns;i++){header+='<th class="excel-table-col" data-col="'+i+'">'+ExcelTable.unit.convertDSTo26BS(i)+'</th>'}header+='</tr></thead>';result='<table>'+header+result+'</table>';this.table.find('table').remove();this.table.append(result);ExcelTable.template.tableHeader(this.table);this.selectLines.render();if(this.history.canRecord){this.history.change()}};this.times=0;this.calculate=function(unit){this.times++;if(this.times>100){throw'execute to many times'}var finder={times:this.times,calculate:this.calculate,result:this.result,range:this.range,origin:unit};var $one=ExcelTable.calculator.functions.finds.one.bind(finder);var $row=ExcelTable.calculator.functions.finds.row.bind(finder);var $col=ExcelTable.calculator.functions.finds.column.bind(finder);var $range=ExcelTable.calculator.functions.finds.range.bind(finder);for(var i in ExcelTable.calculator.functions.public){eval('var '+i.toUpperCase()+'='+ExcelTable.calculator.functions.public[i])}if(unit.type=='function'){var result;try{eval('result'+ExcelTable.unit.parsing(unit.value))}catch(error){console.log(error);result=NaN}return result}else{return unit.value}};this.init=ExcelTable.table.initialize.bind(this);this.action=new ExcelTable.table.Action(this);this.history=new ExcelTable.table.History(this);this.resize=function(){var toolbar=this.target.children('.excel-table-toolbar'),width=this.target.width(),searchValue=this.search.find('.value');searchValue.width(width-132);var height=this.target.height(),tableMinHeight=55,headerHeight=this.search.height()+4+toolbar.height(),remainHeight=height-headerHeight;if(remainHeight<tableMinHeight){this.target.height(headerHeight+tableMinHeight);this.table.height(tableMinHeight)}else{this.table.height(remainHeight)}this.search.width(width);toolbar.width(width);this.table.width(width)}},table:{initialize:function(options){var table=this,excelTableColStatus=false,excelTableRowStatus=false;this.target=$(options.target);this.target.html(ExcelTable.template.table);this.table=this.target.children('.excel-table-content');this.search=this.target.children('.excel-table-search');this.selectLines.target=this.table.children('.excel-table-select-lines');this.changeLines.target=this.table.children('.excel-table-change-lines');this.action.import(options.data).render();this.selectLines.changeActive(0,0);this.resize();this.search.on('change','.value',function(e){ExcelTable.unit.setValue(table.selectLines.getActiveModel(),$(this).val());table.render()}).on('keydown','.value',function(e){var self=$(this);switch(e.keyCode){case 27:self.val(table.selectLines.getActiveModel().value);break}}).on('change','.key',function(e){var self=$(this);var search=self.val().split(',');var int=/^[0-9]+$/;if(search.length==2&&search[0].match(int)&&search[1].match(int)){var row=parseInt(search[0]),col=parseInt(search[1]);table.selectLines.changeActive(row,col).changeRange(row,col).render()}else{self.val(self.data('value'))}});this.table.on('input','input',function(e){ExcelTable.template.input($(this))}).on('keydown','input',function(e){var self=$(this);var unit=self.parent(),row=unit.data('row'),col=unit.data('col');switch(e.keyCode){case 27:self.val(table.result[row][col].value);var triggerEvent=jQuery.Event('mousedown');triggerEvent.button=0;unit.trigger(triggerEvent).trigger('mouseup');break}e.stopPropagation()}).on('change','input',function(e){var unit=$(this).parent(),row=unit.data('row'),col=unit.data('col');ExcelTable.unit.setValue(table.result[row][col],$(this).val());table.render();table.selectLines.changeActive(table.selectLines.active.sRow,table.selectLines.active.sCol);e.stopPropagation()}).on('mousedown dblclick click','input',function(e){e.stopPropagation()}).on('mousedown','.excel-table-unit',function(e){var unit=$(this),row=unit.data('row'),col=unit.data('col'),isSelected=unit.hasClass('select');if(e.button==0&&e.altKey&&isSelected){table.selectLines.changeActive(row,col).render();return false}if(e.button==0||(e.button==2&&!isSelected)){if(!table.changeLines.status){if(table.selectLines.status){$(this).trigger('mouseup')}else{if(e.button==0){table.selectLines.status=true}table.selectLines.changeActive(row,col).changeRange(row,col).render()}}}return false}).on('mousedown','.dot',function(e){if(e.button==0){table.changeLines.status='dot';table.changeLines.render()}return false}).on('mousedown','.w,.s,.a,.d',function(e){if(e.button==0){table.changeLines.status='move';table.changeLines.render()}return false}).on('mouseover','.excel-table-unit',function(e){var unit=$(this),row=unit.data('row'),col=unit.data('col');if(table.selectLines.status){table.selectLines.changeRange(row,col).render()}switch(table.changeLines.status){case'dot':table.changeLines.dot(row,col).render();break;case'move':table.changeLines.move(row,col).render();break}}).on('mouseup','.excel-table-unit',function(e){var unit=$(this),row=unit.data('row'),col=unit.data('col');if(table.selectLines.status){table.selectLines.status=false}switch(table.changeLines.status){case'dot':switch(table.changeLines.type){case'increase':switch(table.changeLines.direction){case'horizontal':table.action.autoFillRight(table.changeLines.eRange.eCol-table.changeLines.sRange.eCol);break;case'vertical':table.action.autoFillBottom(table.changeLines.eRange.eRow-table.changeLines.sRange.eRow);break}break;case'decrease':switch(table.changeLines.direction){case'horizontal':table.action.autoFillLeft(table.changeLines.sRange.sCol-table.changeLines.eRange.sCol);break;case'vertical':table.action.autoFillTop(table.changeLines.sRange.sRow-table.changeLines.eRange.sRow);break}break;case'remove':switch(table.changeLines.direction){case'horizontal':table.action.private.deleteText({sRow:table.changeLines.eRange.sRow,sCol:table.changeLines.eRange.eCol+1,eRow:table.changeLines.sRange.eRow,eCol:table.changeLines.sRange.eCol});break;case'vertical':table.action.private.deleteText({sRow:table.changeLines.eRange.eRow+1,sCol:table.changeLines.eRange.sCol,eRow:table.changeLines.sRange.eRow,eCol:table.changeLines.sRange.eCol});break}break}table.changeLines.mergeRange().render();table.changeLines.status=false;break;case'move':table.action.move(table.changeLines.eRange.sRow,table.changeLines.eRange.sCol).changeLines.mergeRange().render();table.changeLines.status=false;break}table.changeLines.target.hide()}).on('dblclick','.excel-table-unit',function(e){var unit=$(this),row=unit.data('row'),col=unit.data('col');var input=$('<input value="'+table.result[row][col].value+'"/>');unit.html(input);ExcelTable.template.input(input);input.trigger('select')}).on('blur','input',function(e){var unit=$(this).parent(),row=unit.data('row'),col=unit.data('col');unit.html(table.result[row][col].result.toString());e.stopPropagation()}).on('keydown','.excel-table-unit',function(e){var unit=$(this),row=unit.data('row'),col=unit.data('col'),units=table.table.find('.excel-table-unit');if(e.keyCode>=37&&e.keyCode<=40){e.preventDefault();switch(e.keyCode){case 38:--row<0?row=0:'';break;case 40:++row>table.range.eRow?row=table.range.eRow:'';break;case 37:--col<0?col=0:'';break;case 39:++col>table.range.eCol?col=table.range.eCol:'';break}if(e.shiftKey){table.selectLines.changeRange(row,col).render();$(units[col+row*table.range.columns]).trigger('focus')}else{table.selectLines.changeActive(row,col).changeRange(row,col).render()}}else if((!(e.altKey||e.metaKey||e.ctrlKey))&&(e.keyCode==8||e.keyCode==32||(e.keyCode>=48&&e.keyCode<=57)||(e.keyCode>=65&&e.keyCode<=90)||(e.keyCode>=96&&e.keyCode<=111)||(e.keyCode>=186&&e.keyCode<=192)||(e.keyCode>=219&&e.keyCode<=222))){unit.trigger('dblclick')}else if(e.keyCode==9){if(table.selectLines.range.isContains((new Rectangle()).setRange(row,col+1))){col+=1}else if(table.selectLines.range.isContains((new Rectangle()).setRange(row+1,table.selectLines.range.sCol))){row+=1;col=table.selectLines.range.sCol}else{row=table.selectLines.range.sRow;col=table.selectLines.range.sCol}table.selectLines.changeActive(row,col).render();e.preventDefault()}else if(e.keyCode==13){e.preventDefault()}else if((e.metaKey||e.ctrlKey)&&e.keyCode==67){table.action.copy()}else if(e.keyCode==46){table.action.delete().render()}else if((e.metaKey||e.ctrlKey)&&e.keyCode==65){table.target.find('.excel-table-dig').trigger('click');e.preventDefault()}else if((e.metaKey||e.ctrlKey)&&e.keyCode==88){table.action.copy().action.delete().render()}else if((e.metaKey||e.ctrlKey)&&e.keyCode==86){}else if((e.metaKey||e.ctrlKey)&&!e.shiftKey&&e.keyCode==90){table.history.undo()}else if((e.metaKey||e.ctrlKey)&&e.shiftKey&&e.keyCode==90){table.history.redo()}e.stopPropagation()}).on('scroll',function(e){var self=$(this);ExcelTable.template.tableHeader(self);var unit=table.selectLines.getActiveView();var input=unit.find('input');if(input.length){ExcelTable.template.input(input)}}).on('mousedown','.excel-table-col',function(e){if(e.button==0){if(!excelTableColStatus){var col=$(this).data('col');table.selectLines.changeActive(0,col).changeRange(table.range.eRow,col).render();excelTableColStatus=true}else{excelTableColStatus=false}}}).on('mouseover','.excel-table-col',function(e){if(excelTableColStatus){var col=$(this).data('col');table.selectLines.changeRange(table.range.eRow,col).render()}}).on('mouseup','.excel-table-col',function(e){excelTableColStatus=false}).on('contextmenu','.excel-table-col',function(e){var self=$(this);if(!self.hasClass('active')){var col=self.data('col');table.selectLines.changeActive(0,col).changeRange(table.range.eRow,col).render()}e.preventDefault()}).on('mousedown','.excel-table-row',function(e){if(e.button==0){if(!excelTableRowStatus){var row=$(this).data('row');table.selectLines.changeActive(row,0).changeRange(row,table.range.eCol).render();excelTableRowStatus=true}else{excelTableRowStatus=false}}}).on('mouseover','.excel-table-row',function(e){if(excelTableRowStatus){var row=$(this).data('row');table.selectLines.changeRange(row,table.range.eCol).render()}}).on('mouseup','.excel-table-row',function(e){excelTableRowStatus=false}).on('contextmenu','.excel-table-row',function(e){var self=$(this);if(!self.hasClass('active')){var row=self.data('row');table.selectLines.changeActive(row,0).changeRange(row,table.range.eCol).render()}e.preventDefault()}).on('click','.excel-table-dig',function(e){table.selectLines.changeActive(0,0).changeRange(table.range.eRow,table.range.eCol).render()}).on('contextmenu','.excel-table-unit',function(e){$(this).trigger('click');e.preventDefault()}).on('paste','.excel-table-unit',function(e){var txt=e.originalEvent.clipboardData.getData('Text');table.action.paste(txt).render();e.preventDefault();e.stopPropagation()}).on('click',function(){table.selectLines.getActiveView()});if(typeof ContextMenu=='function'){var CM=new ContextMenu();CM.attach('.excel-table-col,.excel-table-row,.excel-table-unit',[{icon:'icon iconfont icon-cut',text:"cut",action:function(){table.action.copy().action.delete().render()}},{icon:'icon iconfont icon-copy',text:"copy",action:function(){table.action.copy()}},{icon:'icon iconfont icon-paste',text:"paste",action:function(){table.action.paste(table.target.find('.clipboard').val()).render()}},{divider:true},{icon:'icon iconfont icon-column-insert',text:"insert",display:function(){return CM.context.hasClass('excel-table-col')},action:function(){table.action.insertColumn(table.selectLines.active.sCol,table.selectLines.range.columns).render()}},{icon:'icon iconfont icon-column-delete',text:"delete",display:function(){return CM.context.hasClass('excel-table-col')},action:function(){table.action.deleteColumn(table.selectLines.range.sCol,table.selectLines.range.eCol).render()}},{icon:'icon iconfont icon-row-insert',text:"insert",display:function(){return CM.context.hasClass('excel-table-row')},action:function(){table.action.insertRow(table.selectLines.active.sRow,table.selectLines.range.rows).render()}},{icon:'icon iconfont icon-row-delete',text:"delete",display:function(){return CM.context.hasClass('excel-table-row')},action:function(){table.action.deleteRow(table.selectLines.range.sRow,table.selectLines.range.eRow).render()}},{text:"clear",action:function(){table.action.delete().render()}}])}},Action:function(parent){this.private={getText:function(rectangle){var txt='';for(var j=rectangle.sRow;j<=rectangle.eRow;j++){for(var i=rectangle.sCol;i<=rectangle.eCol;i++){txt+=parent.result[j][i].value;if(i==rectangle.eCol&&j!=rectangle.eRow){txt+="\n"}else if(i!=rectangle.eCol){txt+="\t"}}}return txt},deleteText:function(rectangle){for(var j=rectangle.sRow;j<=rectangle.eRow;j++){for(var i=rectangle.sCol;i<=rectangle.eCol;i++){ExcelTable.unit.setValue(parent.result[j][i],'')}}},getCRLF:function(txt){var CRLFs=["\r\n","\n\r","\n","\r"];var CRLF=false;for(var i in CRLFs){if(txt.indexOf(CRLFs[i])!=-1){CRLF=CRLFs[i];break}}return CRLF},pasteText:function(sRow,sCol,txt){var CRLF=this.getCRLF(txt);var rows=txt.split(CRLF),cols=[];var extraRows=sRow+rows.length-parent.range.rows;if(extraRows>0){parent.action.insertRow('append',extraRows);parent.dimOne2Two()}rows.forEach(function(v,i){cols=v.split("\t");var extraCols=sCol+cols.length-parent.range.columns;if(extraCols>0){parent.action.insertColumn('append',extraCols);parent.dimOne2Two()}cols.forEach(function(v,j){if(parent.result[sRow+i]&&parent.result[sRow+i][sCol+j]){ExcelTable.unit.setValue(parent.result[sRow+i][sCol+j],v)}})})},csv2json:function(txt){var CRLF=this.getCRLF(txt),rows=txt.split(CRLF),match=/^"(.*)"$/,data={rows:0,columns:0,units:[]};rows.forEach(function(cols,i){cols=cols.split(',');cols.forEach(function(unit,j){unit=unit.replace(match,'$1');data.units.push({row:i,column:j,value:unit});data.columns=j+1;data.rows=i+1})});return data}};this.copy=function(){var txt=this.private.getText(parent.selectLines.range);var clipboard=parent.target.find('.clipboard');clipboard.val(txt).trigger('select');document.execCommand('Copy');return parent};this.delete=function(){this.private.deleteText(parent.selectLines.range);return parent};this.paste=function(txt){this.private.pasteText(parent.selectLines.active.sRow,parent.selectLines.active.sCol,txt);parent.selectLines.changeActive(parent.selectLines.active.sRow,parent.selectLines.active.sCol);return parent};this.import=function(mixed){switch(typeof mixed){case'string':break;case'object':parent.range.setRangeByDistance([0,0],mixed.columns?mixed.columns:1,mixed.rows?mixed.rows:1);parent.units=[];for(var i=0;i<parent.range.rows;i++){for(var j=0;j<parent.range.columns;j++){parent.createUnit(i,j)}}parent.dimOne2Two();if(mixed.units){mixed.units.forEach(function(v){ExcelTable.unit.setValue(parent.result[v.row][v.column],v.value)})}break}return parent};this.export=function(){var data={rows:parent.range.rows,columns:parent.range.columns,units:[]};parent.result.forEach(function(row,i){row.forEach(function(unit,j){if(unit.value==0||unit.value){data.units.push({row:unit.row,column:unit.column,value:unit.value})}})});return data};this.move=function(row,col){var txt=this.private.getText(parent.selectLines.range);this.private.deleteText(parent.selectLines.range);this.private.pasteText(row,col,txt);return parent};this.sort=function(type){switch(type){case'asc':type=1;break;case'desc':type=-1;break;default:return false}var sCol=parent.selectLines.range.sCol,eCol=parent.selectLines.range.eCol;if(parent.selectLines.range.sCol==parent.selectLines.active.sCol&&parent.selectLines.range.eCol==parent.selectLines.active.sCol){sCol=0;eCol=parent.range.eCol}var list=[];for(var i=parent.selectLines.range.sRow;i<=parent.selectLines.range.eRow;i++){list.push(parent.result[i][parent.selectLines.active.sCol])}list.sort(function(a,b){if(a.result==''&&b.result!=''){return 1}else if(a.result!=''&&b.result==''){return-1}if(typeof a.result!='number'&&typeof b.result=='number'){return type}else if(typeof a.result=='number'&&typeof b.result!='number'){return-type}return a.result==b.result?0:a.result>b.result?type:-type});list.forEach(function(v,i){parent.result[v.row].forEach(function(unit){if(unit.column>=sCol&&unit.column<=eCol){unit.row=i}})});return parent};this.deleteRow=function(start,end){if(start>end){[start,end]=[end,start]}if(start<0){start=0}if(end>parent.range.eRow){end=parent.range.eRow}var number=end-start+1;for(i=end+1;i<=parent.range.eRow;i++){for(j=0;j<parent.range.columns;j++){parent.result[i][j].row-=number}}parent.result.splice(start,number);parent.dimTwo2One();parent.range.eRow-=number;parent.range.rows-=number;if(!parent.units.length){this.insertRow(0)}return parent};this.insertRow=function(active,number){var i,j;if(active<0&&active>=-parent.range.rows){active+=parent.range.rows}else if(active>=0&&active<=parent.range.rows){}else if(active=='append'){active=parent.range.rows}else{return false}if(!number){number=1}for(i=active;i<parent.range.rows;i++){for(j=0;j<parent.range.columns;j++){parent.result[i][j].row+=number}}for(i=0;i<parent.range.columns;i++){for(j=active;j<active+number;j++){parent.createUnit(j,i)}}parent.range.eRow+=number;parent.range.rows+=number;return parent};this.deleteColumn=function(start,end){if(start>end){[start,end]=[end,start]}if(start<0){start=0}if(end>parent.range.eCol){end=parent.range.eCol}var number=end-start+1;for(i=0;i<=parent.range.eRow;i++){for(j=end+1;j<parent.range.columns;j++){parent.result[i][j].column-=number}}parent.result.forEach(function(row){row.splice(start,number)});parent.dimTwo2One();parent.range.eCol-=number;parent.range.columns-=number;if(!parent.units.length){this.insertColumn(0)}return parent};this.insertColumn=function(active,number){var i,j;if(active<0&&active>=-parent.range.columns){active+=parent.range.columns}else if(active>=0&&active<=parent.range.columns){}else if(active=='append'){active=parent.range.columns}else{return false}if(!number){number=1}for(i=active;i<parent.range.columns;i++){for(j=0;j<parent.range.rows;j++){parent.result[j][i].column+=number}}for(i=0;i<parent.range.rows;i++){for(j=active;j<active+number;j++){parent.createUnit(i,j)}}parent.range.eCol+=number;parent.range.columns+=number;return parent};this.autoFillRight=function(length){var err,number,first,last,i,j,end,selectRange=parent.selectLines.range;for(j=selectRange.sRow;j<=selectRange.eRow;j++){number=0;first=0;last=0;for(i=selectRange.sCol;i<=selectRange.eCol;i++){if(parent.result[j][i].type=='number'){last=parent.result[j][i].result;if(!number){first=last}number++}}err=(last-first)/(number-1)*number;err=err?err:0;for(i=selectRange.eCol+1,end=selectRange.eCol+length;i<=end;i++){var unit=parent.result[j][i-selectRange.columns];switch(unit.type){case'function':ExcelTable.unit.setValue(parent.result[j][i],unit.value);break;case'number':ExcelTable.unit.setValue(parent.result[j][i],unit.value+err);break;default:ExcelTable.unit.setValue(parent.result[j][i],unit.value);break}}}return parent};this.autoFillBottom=function(length){var err,number,first,last,i,j,end,selectRange=parent.selectLines.range;for(j=selectRange.sCol;j<=selectRange.eCol;j++){number=0;first=0;last=0;for(i=selectRange.sRow;i<=selectRange.eRow;i++){if(parent.result[i][j].type=='number'){last=parent.result[i][j].result;if(!number){first=last}number++}}err=(last-first)/(number-1)*number;err=err?err:0;for(i=selectRange.eRow+1,end=selectRange.eRow+length;i<=end;i++){var unit=parent.result[i-selectRange.rows][j];switch(unit.type){case'function':ExcelTable.unit.setValue(parent.result[i][j],unit.value);break;case'number':ExcelTable.unit.setValue(parent.result[i][j],unit.value+err);break;default:ExcelTable.unit.setValue(parent.result[i][j],unit.value);break}}}return parent};this.autoFillLeft=function(length){var err,number,first,last,i,j,end,selectRange=parent.selectLines.range;for(j=selectRange.sRow;j<=selectRange.eRow;j++){number=0;first=0;last=0;for(i=selectRange.sCol;i<=selectRange.eCol;i++){if(parent.result[j][i].type=='number'){last=parent.result[j][i].result;if(!number){first=last}number++}}err=(last-first)/(number-1)*number;err=err?err:0;for(i=selectRange.sCol-1,end=selectRange.sCol-length;i>=end;i--){var unit=parent.result[j][i+selectRange.columns];switch(unit.type){case'function':ExcelTable.unit.setValue(parent.result[j][i],unit.value);break;case'number':ExcelTable.unit.setValue(parent.result[j][i],unit.value-err);break;default:ExcelTable.unit.setValue(parent.result[j][i],unit.value);break}}}return parent};this.autoFillTop=function(length){var err,number,first,last,i,j,end,selectRange=parent.selectLines.range;for(j=selectRange.sCol;j<=selectRange.eCol;j++){number=0;first=0;last=0;for(i=selectRange.sRow;i<=selectRange.eRow;i++){if(parent.result[i][j].type=='number'){last=parent.result[i][j].result;if(!number){first=last}number++}}err=(last-first)/(number-1)*number;err=err?err:0;for(i=selectRange.sRow-1,end=selectRange.sRow-length;i>=end;i--){var unit=parent.result[i+selectRange.rows][j];switch(unit.type){case'function':ExcelTable.unit.setValue(parent.result[i][j],unit.value);break;case'number':ExcelTable.unit.setValue(parent.result[i][j],unit.value-err);break;default:ExcelTable.unit.setValue(parent.result[i][j],unit.value);break}}}return parent}},History:function(parent){this.canRecord=true;this.list=[];this.active=0;this.undo=function(){if(this.active>=this.list.length-1){return false}this.active+=1;this.canRecord=false;parent.action.import(this.list[this.active]).render();this.canRecord=true};this.redo=function(){if(this.active<=0){return false}this.active-=1;this.canRecord=false;parent.action.import(this.list[this.active]).render();this.canRecord=true};this.change=function(){this.list.splice(0,this.active);this.list.unshift(parent.action.export());this.active=0;if(this.list.length>50){this.list.splice(50,this.list.length)}}},SelectLines:function(parent){this.target=undefined;this.top=0;this.left=0;this.width=0;this.height=0;this.status=false;this.active=new Rectangle();this.range=new Rectangle();this.changeActive=function(row,col){this.active.setRange(row,col);parent.search.children('.key').val(row+','+col).data('value',row+','+col);parent.search.children('.value').val(parent.result[row][col].value);return this};this.changeRange=function(row,col){var change=parent.changeLines;this.range.setRangeByDiagonal([this.active.sRow,this.active.sCol],[row,col]);change.sRange=$.extend(true,change.sRange,this.range);change.eRange=$.extend(true,change.eRange,this.range);return this};this.render=function(){var rows=parent.table.find('.excel-table-row'),cols=parent.table.find('.excel-table-col'),units=parent.table.find('.excel-table-unit');rows.removeClass('active');cols.removeClass('active');units.removeClass('active').removeClass('select');rows.slice(this.range.sRow,this.range.eRow+1).addClass('active');cols.slice(this.range.sCol,this.range.eCol+1).addClass('active');for(var i=this.range.sCol;i<=this.range.eCol;i++){for(var j=this.range.sRow;j<=this.range.eRow;j++){$(units[i+j*(cols.length)]).addClass('select')}}this.getActiveView().addClass('active').trigger('focus');ExcelTable.template.subTable.setWidth(this,cols,this.range.sCol,this.range.eCol);ExcelTable.template.subTable.setHeight(this,rows,this.range.sRow,this.range.eRow);ExcelTable.template.subTable.setPosition(this,units,this.range.sCol,this.range.sRow,cols.length);this.target.find('.dot').css({top:this.top+this.height-2,left:this.left+this.width-2});ExcelTable.template.subTable.outLine(this)};this.getActiveView=function(){var unit=$(parent.table.find('.excel-table-unit')[this.active.sCol+this.active.sRow*parent.range.columns]);if(!unit.find('input').length&&!parent.table.find('.excel-table-unit:focus').length){unit.trigger('focus')}parent.toolbar?parent.toolbar.active=parent:'';return unit};this.getActiveModel=function(){return parent.result[this.active.sRow][this.active.sCol]}},ChangeLines:function(parent){this.target=undefined;this.top=0;this.left=0;this.width=0;this.height=0;this.status=false;this.sRange=new Rectangle();this.eRange=new Rectangle();this.direction='horizontal';this.type='increase';this.move=function(row,col){this.eRange.sCol=col;if(this.eRange.sCol<0){this.eRange.sCol=0}this.eRange.eCol=this.eRange.sCol-this.sRange.sCol+this.sRange.eCol;if(this.eRange.eCol>parent.range.eCol){this.eRange.eCol=parent.range.eCol;this.eRange.sCol=this.eRange.eCol+this.sRange.sCol-this.sRange.eCol}this.eRange.sRow=row;if(this.eRange.sRow<0){this.eRange.sRow=0}this.eRange.eRow=this.eRange.sRow-this.sRange.sRow+this.sRange.eRow;if(this.eRange.eRow>parent.range.eRow){this.eRange.eRow=parent.range.eRow;this.eRange.sRow=this.eRange.eRow+this.sRange.sRow-this.sRange.eRow}this.eRange.setRange(this.eRange.sRow,this.eRange.sCol,this.eRange.eRow,this.eRange.eCol);return this};this.render=function(row,col){var rows=parent.table.find('.excel-table-row'),cols=parent.table.find('.excel-table-col'),units=parent.table.find('.excel-table-unit');ExcelTable.template.subTable.setWidth(this,cols,this.eRange.sCol,this.eRange.eCol);ExcelTable.template.subTable.setHeight(this,rows,this.eRange.sRow,this.eRange.eRow);ExcelTable.template.subTable.setPosition(this,units,this.eRange.sCol,this.eRange.sRow,cols.length);ExcelTable.template.subTable.outLine(this);return this};this.mergeRange=function(){var select=parent.selectLines;select.range=$.extend(true,select.range,this.eRange);this.sRange=$.extend(true,this.sRange,this.eRange);select.active.setRange(select.range.sRow,select.range.sCol);return parent};this.dot=function(row,col){var tCol=col-this.sRange.eCol;var tRow=row-this.sRange.eRow;if(tCol*tRow>=0){if(Math.abs(tCol)>Math.abs(tRow)){this.direction='horizontal'}else{this.direction='vertical'}}else if(tCol>0){this.direction='horizontal'}else{this.direction='vertical'}if(this.direction=='horizontal'){if(this.sRange.eCol<=col){this.type='increase';this.eRange.eCol=col}else if(this.sRange.sCol>col){this.type='decrease';this.eRange.sCol=col}else{this.type='remove';this.eRange.eCol=col}}else{if(this.sRange.eRow<=row){this.type='increase';this.eRange.eRow=row}else if(this.sRange.sRow>row){this.type='decrease';this.eRange.sRow=row}else{this.type='remove';this.eRange.eRow=row}}this.eRange.setRange(this.eRange.sRow,this.eRange.sCol,this.eRange.eRow,this.eRange.eCol);return this}}},template:{table:'<div class="excel-table-toolbar"></div><div class="excel-table-search"><input class="key"><div class="break"><i class="icon iconfont icon-function"> </i></div><input class="value"></div><textarea class="clipboard"></textarea><div class="excel-table-content"><div class="excel-table-select-lines"><div class="w"></div><div class="s"></div><div class="a"></div><div class="d"></div><div class="dot"></div></div><div class="excel-table-change-lines"><div class="w"></div><div class="s"></div><div class="a"></div><div class="d"></div></div></div>',tableHeader:function(table){table.find('.excel-table-col').css('top',table[0].scrollTop);table.find('.excel-table-row').css('left',table[0].scrollLeft);table.find('.excel-table-dig').css({'top':table[0].scrollTop,'left':table[0].scrollLeft})},unit:function(unit){return'<td><div class="excel-table-unit" data-row="'+unit.row+'" data-col="'+unit.column+'" tabindex="1" contenteditable="true">'+unit.result+'</div></td>'},input:function(input){var unit=input.parent(),table=unit.closest('.excel-table-content'),minWidth=unit.width()-6,textWidth=input.val().length*12,position=elementAbsoluteStation(unit[0]),maxWidth=table.width()-position.left-22+table[0].scrollLeft;if(textWidth<minWidth){textWidth=minWidth}else if(textWidth>maxWidth){textWidth=maxWidth}input.width(textWidth);input.height(unit.height()-6)},subTable:{setPosition:function(subTable,units,sCol,sRow,columnLength){var position=elementAbsoluteStation(units[sCol+sRow*(columnLength)]);subTable.top=position.top-2;subTable.left=position.left-2},setWidth:function(subTable,cols,sCol,eCol){subTable.width=0;cols.each(function(i){if(i>=sCol&&i<=eCol){subTable.width+=$(this).width()+2}})},setHeight:function(subTable,rows,sRow,eRow){subTable.height=0;rows.each(function(i){if(i>=sRow&&i<=eRow){subTable.height+=$(this).height()+2}})},outLine:function(subTable){subTable.target.find('.w').css({width:subTable.width,top:subTable.top,left:subTable.left});subTable.target.find('.s').css({width:subTable.width,top:subTable.top+subTable.height,left:subTable.left});subTable.target.find('.a').css({height:subTable.height,top:subTable.top,left:subTable.left});subTable.target.find('.d').css({height:subTable.height,top:subTable.top,left:subTable.left+subTable.width});subTable.target.show()}}},calculator:{functions:{finds:{one:function(row,column){if(this.origin.row==row&&this.origin.column==column){return NaN}if(isNaN(this.result[row][column].result)){return this.calculate(this.result[row][column])}return this.result[row][column].result},row:function(start,end){var result=[];if(start>end){[start,end]=[end,start]}if(end>this.range.eRow){end=this.range.eRow}if(this.origin.row>=start&&this.origin.row<=end){return NaN}for(var i=start;i<=end;i++){for(var j=0;j<this.range.columns;j++){result.push(this.calculate(this.result[i][j]))}}return result},column:function(start,end){var result=[];if(start>end){[start,end]=[end,start]}if(end>this.range.eCol){end=this.range.eCol}if(this.origin.column>=start&&this.origin.column<=end){return NaN}for(var i=start;i<=end;i++){for(var j=0;j<this.range.rows;j++){result.push(this.calculate(this.result[j][i]))}}return result},range:function(start,end){var result=[],i,j;if(start[0]>end[0]){[start[0],end[0]]=[end[0],start[0]]}if(start[1]>end[1]){[start[1],end[1]]=[end[1],start[1]]}if(end[0]>this.range.eRow){end[0]=this.range.eRow}if(end[1]>this.range.eCol){end[1]=this.range.eCol}if(this.origin.column>=start[1]&&this.origin.column<=end[1]&&this.origin.row>=start[0]&&this.origin.row<=end[0]){return NaN}for(j=start[1];j<=end[1];j++){for(i=start[0];i<=end[0];i++){result.push(this.calculate(this.result[i][j]))}}return result}},private:{package:function(value){var result=[];if(typeof value=='object'){for(var i in value){result=result.concat(this.package(value[i]))}}else{result.push(value)}return result}},public:{sum:'function (arr) {arr = ExcelTable.calculator.functions.private.package(arr);var result = 0;arr.forEach(function (v) {if (typeof v != "number") {v = parseFloat(v);if (isNaN(v)) {v = 0;}}result += v;});return result;}',count:'function (arr) {arr = ExcelTable.calculator.functions.private.package(arr);var result = 0;arr.forEach(function (v) {v = parseFloat(v);if (!isNaN(v)) {result++;}});return result;}',avg:'function (arr) {return SUM(arr) / COUNT(arr);}'}}},Toolbar:function(){this.target=undefined;this.active=undefined;this.tables=[];this.items=[[]];this.init=function(options){this.target=$(options.target);options.items.forEach(function(v){if(ExcelTable.toolbar.items[v]){this.items[this.items.length-1].push(ExcelTable.toolbar.items[v])}else if(v=='|'){this.items.push([])}}.bind(this));this.render();this.bind()};this.render=function(){var html='';this.items.forEach(function(block,i){html+='<div class="toolbar-block"><ul>';block.forEach(function(v){if(v.children){html+='<li><button class="'+v.className+'" title="'+v.label+'"><i class="'+v.icon+'"></i><i class="icon iconfont icon-down"></i></button><ul class="children">';v.children.forEach(function(vv){html+='<li><button class="'+ExcelTable.toolbar.items[vv].className+'"><i class="'+ExcelTable.toolbar.items[vv].icon+'"></i>'+ExcelTable.toolbar.items[vv].label+'</button></li>'});html+='</ul></li>'}else{html+='<li><button class="'+v.className+'" title="'+v.label+'"><i class="'+v.icon+'"></i></button></li>'}});html+='</ul></div>'});this.target.html(html)};this.bind=function(){var toolbar=this;for(var i in ExcelTable.toolbar.items){if(ExcelTable.toolbar.items[i].handle){toolbar.target.on('click','.'+i,ExcelTable.toolbar.items[i].handle.bind(toolbar))}}};this.addTable=function(table){this.tables.push(table);this.active=table;table.toolbar=this;table.resize()}},toolbar:{items:{'export':{label:'export',className:'export',icon:'icon iconfont icon-export',children:['export-raw','export-csv']},'export-raw':{label:'export raw',className:'export-raw',icon:'icon iconfont icon-file-json',handle:function(e){var txt=this.active.action.export();var blob=new Blob([JSON.stringify(txt)]);downloadURI(URL.createObjectURL(blob),(new Date()).getTime()+'.json')}},'export-csv':{label:'export csv',className:'export-csv',icon:'icon iconfont icon-file-csv',handle:function(e){var txt=this.active.action.private.getText(this.active.range);txt=txt.replace(/\t/g,'","');txt=txt.replace(/\n/g,'"\n"');txt='"'+txt+'"';var blob=new Blob([txt]);downloadURI(URL.createObjectURL(blob),(new Date()).getTime()+'.csv')}},'import':{label:'import',className:'import',icon:'icon iconfont icon-import',handle:function(e){var input=$('<input type="file">'),table=this.active;input.on('change',function(){var reader=new FileReader(),file=this.files[0];if(file.type=="application/vnd.ms-excel"&&file.name.match(/\.csv$/)){reader.readAsText(file);reader.onload=function(){table.action.import(table.action.private.csv2json(this.result)).render()}}else if(file.name.match(/\.json$/)){reader.readAsText(file);reader.onload=function(){table.action.import(JSON.parse(this.result)).render()}}});input.trigger('click')}},'undo':{label:'undo',className:'undo',icon:'icon iconfont icon-undo',handle:function(e){this.active.history.undo()}},'redo':{label:'redo',className:'redo',icon:'icon iconfont icon-redo',handle:function(e){this.active.history.redo()}},'cut':{label:'cut',className:'cut',icon:'icon iconfont icon-cut',handle:function(e){this.active.action.copy().action.delete().render()}},'copy':{label:'copy',className:'copy',icon:'icon iconfont icon-copy',handle:function(e){this.active.action.copy()}},'paste':{label:'paste',className:'paste',icon:'icon iconfont icon-paste',handle:function(e){var table=this.active,txt=table.target.find('.clipboard').val();table.action.paste(txt).render()}},'append-column':{label:'append column',className:'append-column',icon:'icon iconfont icon-column-append',handle:function(e){this.active.action.insertColumn('append').render()}},'append-row':{label:'append row',className:'append-row',icon:'icon iconfont icon-row-append',handle:function(e){this.active.action.insertRow('append').render()}},'sort-asc':{label:'sort by asc',className:'sort-asc',icon:'icon iconfont icon-sort-by-asc',handle:function(e){this.active.action.sort('asc').render()}},'sort-desc':{label:'sort by desc',className:'sort-desc',icon:'icon iconfont icon-sort-by-desc',handle:function(e){this.active.action.sort('desc').render()}},'auto-fill':{label:'auto fill',className:'auto-fill',icon:'icon iconfont icon-fill',children:['auto-fill-bottom','auto-fill-right','auto-fill-top','auto-fill-left']},'auto-fill-left':{label:'auto fill to left',className:'auto-fill-left',icon:'icon iconfont icon-fill-left',handle:function(e){this.active.action.autoFillLeft(this.active.selectLines.range.sCol).render()}},'auto-fill-right':{label:'auto fill to right',className:'auto-fill-right',icon:'icon iconfont icon-fill-right',handle:function(e){this.active.action.autoFillRight(this.active.range.eCol-this.active.selectLines.range.eCol).render()}},'auto-fill-top':{label:'auto fill to top',className:'auto-fill-top',icon:'icon iconfont icon-fill-top',handle:function(e){this.active.action.autoFillTop(this.active.selectLines.range.sRow).render()}},'auto-fill-bottom':{label:'auto fill to bottom',className:'auto-fill-bottom',icon:'icon iconfont icon-fill-bottom',handle:function(e){this.active.action.autoFillBottom(this.active.range.eRow-this.active.selectLines.range.eRow).render()}},'paste-transform':{label:'paste & transform',className:'paste-transform',icon:'icon iconfont icon-transform',handle:function(e){var table=this.active,rows=table.target.find('.clipboard').val().split("\n"),units=[];rows.forEach(function(row,i){row=row.split("\t");row.forEach(function(unit,j){if(!units[j]){units[j]=[]}units[j][i]=unit})});units.forEach(function(rows,i){units[i]=rows.join("\t")});units=units.join("\n");table.action.paste(units).render()}}}}};
